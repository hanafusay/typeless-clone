name: Release DMG

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build release binary
        run: swift build -c release

      - name: Create app bundle and DMG
        run: ./create-dmg.sh --skip-build

      - name: Get version from tag
        id: version
        run: echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: TypelessClone ${{ steps.version.outputs.tag }}
          body: |
            ## インストール方法

            1. `TypelessClone-*.dmg` をダウンロード
            2. DMG を開いて `TypelessClone.app` を `Applications` にドラッグ
            3. **初回起動:** ダブルクリック → ブロックされたら「完了」→ **システム設定 > プライバシーとセキュリティ** →「このまま開く」
            4. 権限を許可（マイク・音声認識・アクセシビリティ・入力監視）
            5. メニューバーのアイコン →「設定」から Gemini API キーを入力

            > macOS 14 (Sonoma) 以上が必要です。
            > アドホック署名のため初回は「このまま開く」操作が必要です。
          files: dist/*.dmg
          draft: false
          prerelease: false
